#!/usr/bin/python
import argparse
from os import path
import sys

# Insert the relative path to lib
lib_path = path.realpath(path.abspath(path.join(path.dirname(__file__), '..', 'lib')))
sys.path.insert(0, lib_path)
from wrapper import *

if __name__ == "__main__":
    p = argparse.ArgumentParser()

    # Stage Selection
    p.add_argument('-E', action='store_true')
    p.add_argument('-S', action='store_true')
    p.add_argument('-c', action='store_true')

    # Language Options
    p.add_argument('-x', dest='input_language', type=str, help="Treat input files as having type language")
    p.add_argument('-target', dest='intended_target', type=str) # captured just to ignore it

    # Preprocessor Options
    p.add_argument('-nostdinc', action='store_true')

    # Linker Options
    p.add_argument('-L', dest='lib_paths', action='append')
    p.add_argument('-shared', action='store_true')

    # Output Options
    p.add_argument('-emit-llvm', action='store_true')
    p.add_argument('-emit-wasm', action='store_true')
    p.add_argument('-emit-wat', action='store_true')
    p.add_argument('-emit-clif', action='store_true')
    p.add_argument('-emit-obj', action='store_true')
    p.add_argument('-emit-ar', action='store_true')
    p.add_argument('-emit-so', action='store_true')

    # lucetc Options
    p.add_argument('--bindings', dest='bindings', action='append')

    # Input/Output
    p.add_argument('-o', dest='output_file')
    p.add_argument('input_files', type=str, nargs='+', help='input files')

    # Debug Options
    p.add_argument('--verbose', '-v', action='store_true')

    args, unknown_args = p.parse_known_args()

    steps = compiler_workflow(args)
    for (step_fn, in_filename, out_filename)  in steps:
        step_fn(in_filename, out_filename, args, unknown_args)
