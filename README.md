# lucet

Lucet is a native WebAssembly compiler and runtime. It is designed to safely
execute untrusted WebAssembly programs inside your application.

Lucet uses, and is developed in collaboration with, Mozilla's
[Cranelift](http://github.com/cranestation/cranelift) code generator.

Lucet powers Fastly's [Terrarium](https://wasm.fastlylabs.com) platform.

## Status

Lucet supports running WebAssembly programs emitted by Clang, Rustc, and
AssemblyScript. It does not yet support the entire WebAssembly spec, but full
support is coming in the near future.

Lucet's runtime currently only supports x86-64 based Linux systems.

## Contents

### lucetc

`lucetc` is the Lucet Compiler.

The Rust crate `lucetc` provides an executable `lucetc`. It compiles
WebAssembly modules (`.wasm` or `.wat` files) into native code (`.o` or `.so`
files).

### lucet-runtime

`lucet-runtime` is the runtime for WebAssembly modules compiled through
`lucetc`. It is a Rust crate that provides the functionality to load modules
from shared object files, instantiate them, and call exported WebAssembly
functions. `lucet-runtime` manages the resources used by each WebAssembly
instance (linear memory & globals), and the exception mechanisms that detect
and recover from illegal operations.

The bulk of the library is defined in the child crate
`lucet-runtime-internals`.  The public API is exposed in `lucet-runtime`.  Test
suites are defined in the child crate `lucet-runtime-tests`. Many of these
tests invoke `lucetc` and the `wasi-sdk`'s tools.

`lucet-runtime` is usable as a Rust crate or as a C library. The C language interface is found at
`lucet-runtime/include/lucet.h`.

### lucet-module-data

Rust crate describing data structures that are emitted into the object file by
`lucetc`, and consumed by `lucet-runtime`.

### lucet-analyze

Rust executable for inspecting the contents of a shared object generated by `lucetc`.

### lucet-idl

Rust executable that defines an Interface Description Language (IDL) and generates C code.
The generated code provides zero-copy accessor and constructor functions for datatypes
that have the same representation for a WebAssembly guest program and the host program.

Functionality is incomplete at the time of writing, and not yet integrated with
other parts of the project.  Rust code generator, definition of import and
export function interfaces, and opaque type definitions are planned for the
near future.

### lucet-wasi-sdk

`wasi-sdk` is a Cranelift project that packages a build of the Clang toolchain,
the WebAssembly reference sysroot, and a libc that uses the WebAssembly System
Interface (WASI) import functions. `lucet-wasi-sdk` is a Rust crate that provides
a wrapper build C programs into WebAssembly modules using this sdk. Used to build
test cases in `lucet-runtime-tests`.

### lucet-spectest

Rust crate that uses `lucetc` and `lucet-runtime`, as well as the (external) `wabt`
crate, to run the official WebAssembly spec suite, which is provided as a
submodule in this directory. Lucet is not yet fully spec compliant, and the
implementation of `lucet-spectest` has not been maintained very well during recent
codebase evolutions. We expect to fix this up and reach spec compliance in the
near future.

### lucet-builtins

C library that provides optimized native versions of libc primitives. `lucetc` can
substitute the implementations defined in this library for the WebAssembly
implementations.

Contains a Rust crate `wasmonkey` that transforms a WebAssembly module from defining
a function to using it as an import function.

### Vendor libraries

Lucet is tightly coupled to several upstream dependencies, and Lucet
development often requires making changes to these dependencies which are
submitted upstream once fully baked. To reduce friction in this development
cycle, we use git submodules to vendor these modules into the Lucet source
tree. The submodules point at forks under the github.com/fastly orginization to
meet Fastly's source control requirements.

#### Cranelift

We keep the primary Cranelift project repository as a submodule at
`/cranelift`.  The git repo at `https://github.com/fastly/cranelift`
mirrors upstream `https://github.com/cranestation/cranelift`.

Cranelift provides the native code generator used by `lucetc`, and a ton of
supporting infrastructure.

Cranelift was previously known as Cretonne.  Project developers hang out in the
`#cranelift` channel on `irc.mozilla.org:6697`.

#### Faerie

Faerie is a Rust crate for producing ELF files.  Faerie is used by Cranelift
(through the module system's `cranelift-faerie` backend) and also directly by
`lucetc`, for places where the `cranelift-module` API can't do everything we
need.

### Tests

### Benchmarks

We created the `sightglass` benchmarking tool to measure the runtime of C code
compiled through a standard native toolchain against the Lucet toolchain. It
is provided as a submodule at `/sightglass`.

Sightglass ships with a set of microbenchmarks called `shootout`. The scripts
to build the shootout tests with native and various versions of the Lucet
toolchain are in `/benchmarks/shootout`.

## Development Environment

### Operating System

Lucet is developed and tested on Linux. We expect it to work on any POSIX
system which supports ELF.

Experimentally, we have shown that supporting Mac OS (which uses the Mach-O
executable format instead of ELF) is possible, but it is not supported at this
time.

### Dependencies

Lucet requires:

* Rust stable, and `rustfmt`. We typically track the latest stable release.
* `wasi-sdk`, providing a Clang toolchain with wasm-ld, the WebAssembly
  reference sysroot, and a libc that depends on only the WebAssembly System
  Interface (WASI) import functions.
* GNU Make, CMake, & various standard unix utilities for the
  build system
* libhwloc, for sightglass to pin benchmarks to a single core

### Getting started

The easiest way to get started with the Lucet toolchain is by using a Docker container.

This repository includes a `Dockerfile` to build a complete environement for
compiling and running WebAssembly code with Lucet.

#### Setting up the environment

1) Install and run the `docker` service. We do not support `podman` at this time. On MacOS, [Docker for Mac](https://docs.docker.com/docker-for-mac/install/) is an option.
2) Once Docker is running, in a terminal, and at the root of the cloned repository, type: `source ./devenv_build_container.sh`. This command requires the current shell to be `zsh`, `ksh` or `bash`. After a couple minutes, the Docker image is built and a new container is run.
3) Check that new commands are now available:

```sh
lucetc --help
```

You're now all set!

#### Your first Lucet application

Under the hood, these commands are executed in the Docker container. And this container has limited visibility over the host's filesystem. Namely, files that are in the `lucet` directory you just cloned can be compiled and run.

Create a new work directory in that base directory:

```sh
mkdir -p src/hello

cd src/hello
```

Save the following C source code as `hello.c`:

```c
#include <stdio.h>

int main(void)
{
    puts("Hello world");
    return 0;
}
```

Time to compile it! The Docker container includes the `clang` compiler, built to generate webassembly source code. The related commands are accessible from your current shell.

```sh
wasm32-unknown-wasi-clang -Ofast -o hello.wasm hello.c
```

Note that tools from the LLVM/Clang targeting webassembly share a common `wasm32-unknown-wasi-` prefix.

The previous command creates a WebAssembly module `hello.wasm` from our original C source code.

The next step is to build native `x86_64` code from that WebAssembly file.

```sh
lucetc-wasi -o hello.so hello.wasm
```

`lucetc` is the WebAssembly to native code compiler. The `lucetc-wasi` command runs the same compiler, but configured for applications using WASI.

`hello.so` is created and ready to be run:

```sh
lucet-wasi hello.so
```

#### Additional shell commands

* `./devenv_build_container.sh` rebuilds Lucet. This is never required unless you are working on the Lucet code itself.
* `./devenv_run.sh [<command>] [<arg>...]` runs a command in the container. If a command is not provided, an interactive shell is spawned. In this container, Lucet tools are installed in `/opt/lucet` by default. The command `source /opt/lucet/bin/lucet_setenv.sh` can be used to initialize the environment.
* `./devenv_start.sh` and `./devenv_stop.sh` start and stop the container.

## Reporting Security Issues

The Lucet maintainers are committed to providing a prompt response to security
issues. Reporters may make a public report [on GitHub](https://github.com/fastly/lucet),
or make a private report [via Fastly's security reporting system](https://www.fastly.com/security/report-security-issue)